<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>三人用 手番タイマー</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    background: #f6f7fb;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
  }
  #stage {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }

  /* 中央の秒表示 */
  #timer {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-weight: 700;
    line-height: 1;
    text-align: center;
    letter-spacing: 0.02em;
    /* サイズは画面に応じて可変 */
    font-size: min(20vw, 18vh);
    color: #111;
    transition: color .15s ease;
  }
  #timer.timeout {
    color: #e21d1d;
  }

  /* 丸（プレイヤーの位置マーカー） */
  .dot {
    position: absolute;
    width: min(14vw, 14vh);
    height: min(14vw, 14vh);
    background: #dfe3ea;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,.12) inset, 0 1px 2px rgba(0,0,0,.06);
    transition: transform .2s ease, background .2s ease, box-shadow .2s ease, opacity .2s ease;
    opacity: .85;
  }
  .dot.active {
    background: #7ee27a; /* 強調色（緑） */
    transform: scale(1.22);
    box-shadow: 0 0 0 8px rgba(126,226,122,.25), 0 8px 24px rgba(0,0,0,.18);
    opacity: 1;
  }
  /* 配置：左・下・右 */
  #dot-left {
    left: 5vw;
    top: 50%;
    transform: translateY(-50%);
  }
  #dot-right {
    right: 5vw;
    top: 50%;
    transform: translateY(-50%);
  }
  #dot-bottom {
    left: 50%;
    bottom: 4vh;
    transform: translateX(-50%);
  }

  /* 画面タップで手番交代する案内（数秒でフェードアウト） */
  #hint {
    position: absolute;
    left: 50%;
    bottom: 2.6vh;
    transform: translateX(-50%);
    font-size: min(4.2vw, 2.6vh);
    color: #6b7280;
    background: rgba(255,255,255,.7);
    padding: .5em 1em;
    border-radius: 999px;
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
    opacity: 1;
    transition: opacity .6s ease;
  }
  #hint.hide { opacity: 0; }

  /* フルスクリーン化（iOSホーム追加時の余白対策） */
  @supports (-webkit-touch-callout: none) {
    html, body { height: -webkit-fill-available; }
    #stage { height: -webkit-fill-available; }
  }
</style>
</head>
<body>
  <div id="stage" aria-label="三人用手番タイマー（タップまたはEnterで手番交代）">
    <div id="timer">0.0</div>
    <div id="dot-left" class="dot"></div>
    <div id="dot-bottom" class="dot"></div>
    <div id="dot-right" class="dot"></div>
    <div id="hint">タップ or Enter（シャッター）で手番交代</div>
  </div>

<script>
(() => {
  'use strict';

  // 要素取得
  const timerEl = document.getElementById('timer');
  const hintEl  = document.getElementById('hint');
  const dots = [
    document.getElementById('dot-left'),
    document.getElementById('dot-bottom'),
    document.getElementById('dot-right'),
  ]; // 順序：左→下→右

  // 状態
  let currentIndex = 0;          // 0: 左, 1: 下, 2: 右
  let running = false;
  let startTime = 0;             // この手番の開始時刻（performance.now）
  let elapsed = 0;               // この手番の経過秒
  let rafId = null;
  let beepedThisTurn = false;    // 10秒を超えた時に一度だけ鳴らす

  // 初期ハイライト
  function updateDots() {
    dots.forEach((d, i) => {
      if (i === currentIndex) d.classList.add('active');
      else d.classList.remove('active');
    });
  }

  // タイマー更新（高精度・滑らか）
  function tick(now) {
    if (!running) return;
    const diff = (now - startTime) / 1000;
    elapsed = diff;
    const shown = Math.max(0, elapsed);
    // 1桁小数表示
    timerEl.textContent = shown.toFixed(1);

    // 10秒超えアラート（1回だけピコン）
    if (shown >= 10 && !beepedThisTurn) {
      timerEl.classList.add('timeout');
      beepOnce();
      beepedThisTurn = true;
    }

    rafId = requestAnimationFrame(tick);
  }

  // 手番を次へ（左→下→右→左→…）
  function advanceTurn() {
    // 次の人へ
    currentIndex = (currentIndex + 1) % 3;
    updateDots();

    // タイマーをリセットして再開
    timerEl.classList.remove('timeout');
    beepedThisTurn = false;
    startTime = performance.now();
    elapsed = 0;
    timerEl.textContent = '0.0';

    if (!running) {
      running = true;
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(tick);
    } else {
      // running中でもstartTimeを今に更新
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(tick);
    }

    // ヒントをフェードアウト
    if (hintEl && !hintEl.classList.contains('hide')) {
      setTimeout(() => hintEl.classList.add('hide'), 1200);
    }
  }

  // 初回：左から開始して、1回ボタンが押されたら計測開始（0から）
  updateDots();
  timerEl.textContent = '0.0';

  // 入力（タップ／クリック／Enter／Space）
  function handleAdvanceIntent() {
    advanceTurn();
  }

  // 画面どこでもタップで交代
  document.addEventListener('click', handleAdvanceIntent, { passive: true });
  document.addEventListener('touchend', handleAdvanceIntent, { passive: true });

  // キーボード（BluetoothシャッターがEnter/Spaceの想定）
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      handleAdvanceIntent();
    }
  });

  // WebAudioで短いピコン音（約150ms）
  function beepOnce() {
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = 'sine';
      // 明るめのピコン（880Hz → 1320Hzのミニグリッサンド）
      osc.frequency.setValueAtTime(880, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(1320, ctx.currentTime + 0.12);

      gain.gain.setValueAtTime(0.0001, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.16);

      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.18);
    } catch (err) {
      // 音が出せない環境でもアプリは継続
      console.warn('beep error', err);
    }
  }

  // 画面回転時も見やすいように再配置（CSSが相対なのでJSは不要だが、iOSの描画更新を促す）
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      // reflow
      timerEl.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 100);
  });
})();
</script>
</body>
</html>
